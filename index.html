<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–º–µ—Ä–∞ –∏ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      color: #333;
    }

    header {
      background-color: #004080;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
    }

    .container {
      padding: 16px;
      max-width: 600px;
      margin: auto;
    }

    video, canvas, img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      margin-bottom: 10px;
    }

    .btn {
      display: inline-block;
      margin: 8px 4px;
      padding: 10px 16px;
      font-size: 1rem;
      color: white;
      background-color: #0070cc;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #005bb5;
    }

    .info {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #444;
    }

    select {
      padding: 8px;
      margin-top: 10px;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <header>üì∑ –ö–∞–º–µ—Ä–∞ –∏ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</header>

  <div class="container" id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function CameraGeoApp() {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [devices, setDevices] = useState([]);
      const [selectedDeviceId, setSelectedDeviceId] = useState('');
      const [hasCamera, setHasCamera] = useState(false);
      const [geo, setGeo] = useState(null);
      const [imageURL, setImageURL] = useState(null);
      const streamRef = useRef(null);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
      async function checkPermissions() {
        if (!navigator.permissions) return;

        try {
          const cameraPerm = await navigator.permissions.query({ name: 'camera' });
          if (cameraPerm.state === 'denied') {
            alert("–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
          }

          const geoPerm = await navigator.permissions.query({ name: 'geolocation' });
          if (geoPerm.state === 'denied') {
            alert("–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
          }
        } catch (err) {
          console.warn("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:", err);
        }
      }

      useEffect(() => {
        checkPermissions();
        getDevices();
        getGeolocation();
      }, []);

      // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
      async function getDevices() {
        try {
          const allDevices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = allDevices.filter(device => device.kind === 'videoinput');
          setDevices(videoDevices);
          if (videoDevices.length > 0) {
            setSelectedDeviceId(videoDevices[0].deviceId);
          }
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤:", err);
        }
      }

      // –ü–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
      function getGeolocation() {
        if (!navigator.geolocation) {
          alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            setGeo({ latitude, longitude });
          },
          (err) => {
            console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", err);
            let msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.";
            if (err.code === 1) msg = "–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω.";
            else if (err.code === 2) msg = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.";
            else if (err.code === 3) msg = "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.";
            alert(msg);
          }
        );
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É
      useEffect(() => {
        if (!selectedDeviceId) return;

        async function initCamera() {
          try {
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç—Ä–∏–º
            if (streamRef.current) {
              streamRef.current.getTracks().forEach(track => track.stop());
            }

            const stream = await navigator.mediaDevices.getUserMedia({
              video: { deviceId: { exact: selectedDeviceId } }
            });

            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            setHasCamera(true);
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.");
            setHasCamera(false);
          }
        }

        initCamera();

        return () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
          }
        };
      }, [selectedDeviceId]);

      const takePhoto = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/png');
        setImageURL(dataUrl);
      };

      const downloadImage = () => {
        if (!imageURL) return;
        const a = document.createElement('a');
        a.href = imageURL;
        a.download = 'snapshot.png';
        a.click();
      };

      return (
        <div>
          {hasCamera ? (
            <div>
              <video ref={videoRef} autoPlay playsInline muted />
              <div>
                <select onChange={e => setSelectedDeviceId(e.target.value)} value={selectedDeviceId}>
                  {devices.map((device, index) => (
                    <option key={device.deviceId} value={device.deviceId}>
                      {device.label || `–ö–∞–º–µ—Ä–∞ #${index + 1}`}
                    </option>
                  ))}
                </select>
              </div>
              <button className="btn" onClick={takePhoto}>üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
              <canvas ref={canvasRef} style={{ display: 'none' }}></canvas>
              {imageURL && (
                <div>
                  <img src={imageURL} alt="–°–Ω–∏–º–æ–∫" />
                  <button className="btn" onClick={downloadImage}>üíæ –°–∫–∞—á–∞—Ç—å</button>
                </div>
              )}
              <div className="info">
                üåç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:{" "}
                {geo ? (
                  <span>
                    —à–∏—Ä–æ—Ç–∞: <b>{geo.latitude.toFixed(6)}</b>, –¥–æ–ª–≥–æ—Ç–∞: <b>{geo.longitude.toFixed(6)}</b>
                  </span>
                ) : (
                  "–ø–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã..."
                )}
              </div>
            </div>
          ) : (
            <p>‚è≥ –û–∂–∏–¥–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...</p>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<CameraGeoApp />);
  </script>
</body>
</html>
