<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–º–µ—Ä–∞ –∏ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</title>

  <!-- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å -->
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      color: #333;
    }

    header {
      background-color: #004080;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
    }

    .container {
      padding: 16px;
      max-width: 600px;
      margin: auto;
    }

    video, canvas, img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      margin-bottom: 10px;
    }

    .btn {
      display: inline-block;
      margin: 8px 4px;
      padding: 10px 16px;
      font-size: 1rem;
      color: white;
      background-color: #0070cc;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #005bb5;
    }

    .info {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #444;
    }

    select {
      padding: 8px;
      margin-top: 10px;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <header>
    üì∑ –ö–∞–º–µ—Ä–∞ –∏ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
  </header>

  <div class="container" id="root"></div>

  <!-- React –∏ Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function CameraGeoApp() {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [devices, setDevices] = useState([]);
      const [selectedDeviceId, setSelectedDeviceId] = useState('');
      const [hasCamera, setHasCamera] = useState(false);
      const [geo, setGeo] = useState(null);
      const [imageURL, setImageURL] = useState(null);

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä
      useEffect(() => {
        async function getDevices() {
          const allDevices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = allDevices.filter(device => device.kind === 'videoinput');
          setDevices(videoDevices);
          if (videoDevices.length > 0) {
            setSelectedDeviceId(videoDevices[0].deviceId);
          }
        }
        getDevices();
      }, []);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
      useEffect(() => {
        if (!selectedDeviceId) return;

        async function initCamera() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { deviceId: { exact: selectedDeviceId } }
            });
            videoRef.current.srcObject = stream;
            setHasCamera(true);
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.");
          }
        }

        initCamera();
      }, [selectedDeviceId]);

      // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
      useEffect(() => {
        if (!navigator.geolocation) {
          alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            setGeo({ latitude, longitude });
          },
          (err) => {
            console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.");
          }
        );
      }, []);

      const takePhoto = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/png');
        setImageURL(dataUrl);
      };

      const downloadImage = () => {
        if (!imageURL) return;
        const a = document.createElement('a');
        a.href = imageURL;
        a.download = 'snapshot.png';
        a.click();
      };

      return (
        <div>
          {hasCamera ? (
            <div>
              <video ref={videoRef} autoPlay playsInline />
              <div>
                <select onChange={e => setSelectedDeviceId(e.target.value)} value={selectedDeviceId}>
                  {devices.map(device => (
                    <option key={device.deviceId} value={device.deviceId}>
                      {device.label || "–ö–∞–º–µ—Ä–∞"}
                    </option>
                  ))}
                </select>
              </div>
              <button className="btn" onClick={takePhoto}>üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
              <canvas ref={canvasRef} style={{ display: 'none' }}></canvas>
              {imageURL && (
                <div>
                  <img src={imageURL} alt="–°–Ω–∏–º–æ–∫" />
                  <button className="btn" onClick={downloadImage}>üíæ –°–∫–∞—á–∞—Ç—å</button>
                </div>
              )}
              <div className="info">
                üåç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:{" "}
                {geo ? (
                  <span>
                    —à–∏—Ä–æ—Ç–∞: <b>{geo.latitude.toFixed(6)}</b>, –¥–æ–ª–≥–æ—Ç–∞: <b>{geo.longitude.toFixed(6)}</b>
                  </span>
                ) : (
                  "–ø–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã..."
                )}
              </div>
            </div>
          ) : (
            <p>–û–∂–∏–¥–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...</p>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<CameraGeoApp />);
  </script>
</body>
</html>
